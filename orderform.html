<section id="order-section" style="max-width: 95%; margin: 30px auto; background: #ffffff; padding: 25px 20px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); font-family: Arial, sans-serif; font-size: 18px;">
  <h2 style="text-align: center; color: #0b8457; font-size: 24px;">ğŸ¥¿ Mwalimu Footwear Order Form</h2>
  <p style="text-align: center; color: #666; font-size: 16px;">Select shoe sizes and complete your details below to place your order.</p>
  
  <form id="orderForm" action="https://formspree.io/f/mdkpqepq" method="POST" style="margin-top: 20px;">
    <div id="cart-items" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; text-align: center; justify-items: center;"></div>

    <hr style="margin: 25px 0;">

    <label for="phone" style="display:block; margin-top:15px; color:#444; font-size:17px;">ğŸ“± Phone Number</label>
    <input type="tel" id="phone" name="phone" placeholder="e.g. 0712345678" required style="width:100%; padding:14px; border:1px solid #ccc; border-radius:10px; font-size:17px;">

    <label for="location" style="display:block; margin-top:15px; color:#444; font-size:17px;">ğŸ“ Delivery Location</label>
    <input type="text" id="location" name="location" placeholder="e.g. Mandera Town" required style="width:100%; padding:14px; border:1px solid #ccc; border-radius:10px; font-size:17px;">

    <label for="totalPrice" style="display:block; margin-top:15px; color:#444; font-size:17px;">ğŸ’° Total Price (KSh)</label>
    <input type="text" id="totalPrice" name="totalPrice" readonly style="width:100%; padding:14px; border:1px solid #ccc; border-radius:10px; font-size:17px; background:#f0f0f0; color:#333;">

    <label for="payment" style="display:block; margin-top:15px; color:#444; font-size:17px;">ğŸ’³ Payment Type</label>
    <select id="payment" name="payment_type" required style="width:100%; padding:14px; border:1px solid #ccc; border-radius:10px; background:#fff; font-size:17px;">
      <option value="" disabled selected>Select Payment Type</option>
      <option value="Payment on Delivery">Payment on Delivery</option>
      <option value="Payment Before Delivery">Payment Before Delivery</option>
    </select>

    <label for="message" style="display:block; margin-top:15px; color:#444; font-size:17px;">ğŸ“ Additional Notes</label>
    <textarea id="message" name="message" placeholder="Any special requests?" rows="3" style="width:100%; padding:14px; border:1px solid #ccc; border-radius:10px; font-size:17px;"></textarea>

    <button type="submit" style="margin-top:25px; width:100%; background:#0b8457; color:#fff; padding:15px; border:none; border-radius:10px; font-size:18px; cursor:pointer;">Place Order âœ…</button>
    <button type="button" id="clearCart" style="margin-top:10px; width:100%; background:#e74c3c; color:#fff; padding:15px; border:none; border-radius:10px; font-size:18px; cursor:pointer;">Clear Cart ğŸ—‘ï¸</button>
  </form>

  <p id="form-message" style="text-align:center; font-weight:bold; margin-top:20px; font-size:16px;"></p>
</section>

<script>
  const cartContainer = document.getElementById('cart-items');
  const form = document.getElementById('orderForm');
  const message = document.getElementById('form-message');
  const totalPriceField = document.getElementById('totalPrice');
  const clearCartBtn = document.getElementById('clearCart');

  let cart = JSON.parse(localStorage.getItem('cart')) || [];

  const calculateTotal = () => cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
  const updateTotalPrice = () => { totalPriceField.value = calculateTotal(); }

  const createSizeDropdowns = (index, quantity) => {
    if (quantity === 1) {
      // Single dropdown takes full width
      return `
        <select name="size_${index}_0" required style="width:100%; padding:6px; border:1px solid #ccc; border-radius:6px; font-size:15px;">
          <option value="" disabled selected>Select Size</option>
          ${Array.from({length: 15}, (_, j) => `<option value="${j + 32}">${j + 32}</option>`).join('')}
        </select>
      `;
    } else {
      // Multiple dropdowns in row
      let html = '';
      for (let i = 0; i < quantity; i++) {
        html += `
          <select name="size_${index}_${i}" required style="padding:4px 6px; margin-left:4px; border:1px solid #ccc; border-radius:6px; font-size:14px;">
            <option value="" disabled selected>Size ${i+1}</option>
            ${Array.from({length: 15}, (_, j) => `<option value="${j + 32}">${j + 32}</option>`).join('')}
          </select>
        `;
      }
      return html;
    }
  };

  const renderCart = () => {
    cartContainer.innerHTML = '';
    if (cart.length === 0) {
      cartContainer.innerHTML = "<p style='color:red; text-align:center;'>ğŸ›’ Your cart is empty.</p>";
      totalPriceField.value = 0;
      return;
    }

    cart.forEach((item, index) => {
      const div = document.createElement('div');
      div.style.background = '#f9f9f9';
      div.style.border = '1px solid #ddd';
      div.style.borderRadius = '10px';
      div.style.padding = '8px';
      div.style.fontSize = '15px';
      div.style.display = 'flex';
      div.style.flexDirection = 'column';
      div.style.alignItems = 'center';
      div.style.width = '200px';

      div.innerHTML = `
        <div style="width:100%; height:120px; overflow:hidden; border-radius:8px; margin-bottom:8px;">
          <img src="${item.image}" alt="${item.name}" style="width:100%; height:100%; object-fit:cover;">
        </div>
        <div style="display:flex; align-items:center; flex-wrap:wrap; justify-content:center; width:100%;">
          <label style="font-size:14px; font-weight:bold;">Quantity: </label>
          <input type="number" min="1" value="${item.quantity}" data-index="${index}" style="width:50px; margin-left:4px; padding:4px; border:1px solid #ccc; border-radius:6px; font-size:14px;">
          <div class="size-container" data-index="${index}" style="display:flex; flex-wrap:wrap; margin-left:8px; width:${item.quantity === 1 ? '100%' : 'auto'};">
            ${createSizeDropdowns(index, item.quantity)}
          </div>
        </div>
        <input type="hidden" name="product_${index}" value="${item.name}">
      `;
      cartContainer.appendChild(div);
    });

    updateTotalPrice();

    // Quantity change event
    cartContainer.querySelectorAll('input[type="number"]').forEach(input => {
      input.addEventListener('change', (e) => {
        const i = e.target.getAttribute('data-index');
        let newQty = parseInt(e.target.value);
        if (isNaN(newQty) || newQty < 1) newQty = 1;
        cart[i].quantity = newQty;
        localStorage.setItem('cart', JSON.stringify(cart));

        // Update size dropdowns dynamically
        const sizeContainer = cartContainer.querySelector(`.size-container[data-index="${i}"]`);
        sizeContainer.innerHTML = createSizeDropdowns(i, newQty);
        sizeContainer.style.width = newQty === 1 ? '100%' : 'auto';

        updateTotalPrice();
      });
    });
  };

  renderCart();

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    message.style.color = '#0b8457';
    message.textContent = "Submitting your order...";

    const response = await fetch(form.action, {
      method: 'POST',
      body: new FormData(form),
      headers: { 'Accept': 'application/json' }
    });

    if (response.ok) {
      message.style.color = '#0b8457';
      message.textContent = "âœ… Thank you! Your order has been received. We'll contact you soon.";
      form.reset();
      renderCart();
    } else {
      message.style.color = 'red';
      message.textContent = "âŒ Something went wrong. Please try again later.";
    }
  });

  clearCartBtn.addEventListener('click', () => {
    localStorage.removeItem('cart');
    cart = [];
    renderCart();
    message.textContent = "";
  });
</script>

<div class="contact-banner" style="text-align:center; margin:30px 0; font-size:17px;">
  ğŸ“ Call: <a href="tel:+254117646714" style="color:#0b8457;">+254117646714</a> &nbsp; | &nbsp;
  <img src="data/images/wicn.jpg" alt="WhatsApp" style="width:22px; vertical-align:middle;"> 
  <a href="https://wa.me/254117646714" target="_blank" style="color:#0b8457;">Chat on WhatsApp</a>
</div>

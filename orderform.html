<section id="order-section" 
         style="position: relative; 
                max-width: 98%; 
                margin: 40px auto; 
                padding: 40px 35px; 
                border-radius: 20px; 
                box-shadow: 0 6px 15px rgba(0,0,0,0.1); 
                font-family: Arial, sans-serif; 
                font-size: 19px; 
                overflow: hidden;">

  <!-- Cart section (no background) -->
  <div id="cart-items" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 25px; text-align: center; justify-items: center; margin-bottom:40px;"></div>

  <hr style="margin: 40px 0;">

  <!-- Form wrapper with logo background -->
  <div style="position: relative; 
              border-radius:20px; 
              background: url('data/images/logo.png') no-repeat center center; 
              background-size: cover; 
              overflow: hidden; 
              padding: 40px 35px;">

    <!-- Semi-transparent overlay -->
    <div style="position:absolute; top:0; left:0; width:100%; height:100%; background-color: rgba(255,255,255,0.6); border-radius:20px;"></div>
    
    <!-- Form content -->
    <div style="position: relative; z-index: 2;">
      <h2 style="text-align: center; color: #0b8457; font-size: 30px; margin-bottom: 20px;">ğŸ¥¿ Mwalimu Footwear Order Form</h2>
      <p style="text-align: center; color: #666; font-size: 18px; margin-bottom: 35px;">Complete your details below to place your order.</p>
      
      <form id="orderForm" action="https://formspree.io/f/mdkpqepq" method="POST" style="margin-top: 20px;">

        <label for="phone" style="display:block; margin-top:30px; color:#444; font-size:20px;">ğŸ“± Phone Number</label>
        <input type="tel" id="phone" name="phone" required 
               style="width:100%; padding:22px; border:1px solid #ccc; border-radius:16px; font-size:19px; margin-bottom:30px; height:60px;">

        <label for="location" style="display:block; margin-top:30px; color:#444; font-size:20px;">ğŸ“ Delivery Location</label>
        <input type="text" id="location" name="location" required 
               style="width:100%; padding:22px; border:1px solid #ccc; border-radius:16px; font-size:19px; margin-bottom:30px; height:60px;">

        <label for="totalPrice" style="display:block; margin-top:30px; color:#444; font-size:20px;">ğŸ’° Total Price (KSh)</label>
        <input type="text" id="totalPrice" name="totalPrice" readonly 
               style="width:100%; padding:22px; border:1px solid #ccc; border-radius:16px; font-size:19px; background:#f0f0f0; color:#333; margin-bottom:30px; height:60px;">

        <label for="payment" style="display:block; margin-top:30px; color:#444; font-size:20px;">ğŸ’³ Payment Type</label>
        <select id="payment" name="payment_type" required 
                style="width:100%; padding:22px; border:1px solid #ccc; border-radius:16px; background:#fff; font-size:19px; margin-bottom:30px; height:60px;">
          <option value="" disabled selected>Select Payment Type</option>
          <option value="Payment on Delivery">Payment on Delivery</option>
          <option value="Payment Before Delivery">Payment Before Delivery</option>
        </select>

        <label for="message" style="display:block; margin-top:30px; color:#444; font-size:20px;">ğŸ“ Additional Notes</label>
        <textarea id="message" name="message" placeholder="Any special requests?" rows="4" 
                  style="width:100%; padding:22px; border:1px solid #ccc; border-radius:16px; font-size:19px; margin-bottom:35px; height:90px;"></textarea>

        <button type="submit" style="margin-top:25px; width:100%; background:#0b8457; color:#fff; padding:24px; border:none; border-radius:16px; font-size:21px; cursor:pointer;">Submit Order âœ…</button>
        <button type="button" id="clearCart" style="margin-top:15px; width:100%; background:#e74c3c; color:#fff; padding:22px; border:none; border-radius:16px; font-size:20px; cursor:pointer;">Clear Cart ğŸ—‘ï¸</button>
      </form>

      <p id="form-message" style="text-align:center; font-weight:bold; margin-top:35px; font-size:18px;"></p>
    </div>
  </div>
</section>

<script>
  const cartContainer = document.getElementById('cart-items');
  const form = document.getElementById('orderForm');
  const message = document.getElementById('form-message');
  const totalPriceField = document.getElementById('totalPrice');
  const clearCartBtn = document.getElementById('clearCart');

  let cart = JSON.parse(localStorage.getItem('cart')) || [];

  const calculateTotal = () => cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
  const updateTotalPrice = () => { totalPriceField.value = calculateTotal(); }

  const createSizeDropdowns = (index, quantity) => {
    let html = '';
    for (let i = 0; i < quantity; i++) {
      html += `
        <select name="size_${index}_${i}" required 
                style="padding:12px; margin:6px 4px 0 0; border:1px solid #ccc; border-radius:10px; font-size:18px; height:50px; ${quantity===1 ? 'width:100%;' : 'width:auto;'}">
          <option value="" disabled selected>${quantity===1 ? 'Select Size' : 'Size ' + (i+1)}</option>
          ${Array.from({length: 15}, (_, j) => `<option value="${j + 32}">${j + 32}</option>`).join('')}
        </select>
      `;
    }
    return html;
  };

  const renderCart = () => {
    cartContainer.innerHTML = '';
    if (cart.length === 0) {
      cartContainer.innerHTML = "<p style='color:red; text-align:center;'>ğŸ›’ Your cart is empty.</p>";
      totalPriceField.value = 0;
      return;
    }

    cart.forEach((item, index) => {
      const div = document.createElement('div');
      div.style.background = '#f9f9f9';
      div.style.border = '1px solid #ddd';
      div.style.borderRadius = '16px';
      div.style.padding = '15px';
      div.style.fontSize = '16px';
      div.style.display = 'flex';
      div.style.flexDirection = 'column';
      div.style.alignItems = 'center';
      div.style.width = '270px';
      div.style.minHeight = '380px';
      div.style.maxHeight = '480px';

      div.innerHTML = `
        <div style="width:100%; height:260px; overflow:hidden; border-radius:14px; margin-bottom:15px;">
          <img src="${item.image}" alt="${item.name}" style="width:100%; height:100%; object-fit:cover;">
        </div>
        <div style="display:flex; align-items:center; flex-wrap:wrap; justify-content:center; width:100%; margin-bottom:12px;">
          <label style="font-size:17px; font-weight:bold;">Quantity: </label>
          <input type="number" min="1" value="${item.quantity}" data-index="${index}" 
                 style="width:65px; margin-left:8px; padding:8px; border:1px solid #ccc; border-radius:10px; font-size:17px; height:50px;">
          <div class="size-container" data-index="${index}" style="display:flex; flex-wrap:wrap; margin-left:10px; width:${item.quantity === 1 ? '100%' : 'auto'};">
            ${createSizeDropdowns(index, item.quantity)}
          </div>
        </div>
        <input type="hidden" name="product_${index}" value="${item.name}">
      `;
      cartContainer.appendChild(div);
    });

    updateTotalPrice();

    cartContainer.querySelectorAll('input[type="number"]').forEach(input => {
      input.addEventListener('change', (e) => {
        const i = e.target.getAttribute('data-index');
        let newQty = parseInt(e.target.value);
        if (isNaN(newQty) || newQty < 1) newQty = 1;
        cart[i].quantity = newQty;
        localStorage.setItem('cart', JSON.stringify(cart));

        const sizeContainer = cartContainer.querySelector(`.size-container[data-index="${i}"]`);
        sizeContainer.innerHTML = createSizeDropdowns(i, newQty);
        sizeContainer.style.width = newQty === 1 ? '100%' : 'auto';

        updateTotalPrice();
      });
    });
  };

  renderCart();

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    message.style.color = '#0b8457';
    message.textContent = "Submitting your order...";

    const response = await fetch(form.action, {
      method: 'POST',
      body: new FormData(form),
      headers: { 'Accept': 'application/json' }
    });

    if (response.ok) {
      message.style.color = '#0b8457';
      message.textContent = "âœ… Thank you! Your order has been received. Delivery cost may apply depending on your location.";
      form.reset();
      renderCart(); // cart remains same unless cleared
    } else {
      message.style.color = 'red';
      message.textContent = "âŒ Something went wrong. Please try again later.";
    }
  });

  clearCartBtn.addEventListener('click', () => {
    localStorage.removeItem('cart');
    cart = [];
    renderCart();
    message.textContent = "";
  });
</script>
